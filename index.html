<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Bar SPEC Menu</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Bar SPEC">
<link rel="apple-touch-icon" href="images/logo.png">

<style>
    :root { --bg-sidebar: #1a1a1a; --bg-main: #252525; --accent-gold: #c5a059; --text-white: #e0e0e0; --text-gray: #888; }
    body { margin: 0; padding: 0; font-family: "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-sidebar); color: var(--text-white); height: 100vh; overflow: hidden; display: flex; }

    /* サイドバー */
    .sidebar { width: 140px; background-color: var(--bg-sidebar); display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid #333; overflow-y: auto; }
    .tab-link { display: block; text-decoration: none; padding: 20px 15px; color: var(--text-gray); font-size: 0.9rem; border-bottom: 1px solid #2a2a2a; transition: 0.3s; cursor: pointer; }
    .tab-link.active { background-color: var(--accent-gold); color: #000; font-weight: bold; }

    /* メインエリア */
    .main-area { flex: 1; background-color: var(--bg-main); display: flex; flex-direction: column; overflow: hidden; }
    .header { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
    .page-title { margin: 0; font-size: 1.6rem; color: var(--accent-gold); font-family: "YuMincho", serif; }
    .lang-btns { display: flex; gap: 4px; }
    .lang-btn { background: #333; border: none; color: #888; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
    .lang-btn.active { background: var(--accent-gold); color: #000; }

    /* フィルター・ソート */
    .filter-area { padding: 10px 30px; background: #2a2a2a; border-bottom: 1px solid #333; display: flex; flex-direction: column; gap: 8px; }
    .region-row, .sub-region-row { display: flex; gap: 6px; flex-wrap: wrap; }
    .filter-btn { padding: 4px 10px; background: transparent; border: 1px solid #555; color: #aaa; cursor: pointer; font-size: 0.75rem; border-radius: 3px; }
    .filter-btn.active { background: var(--accent-gold); color: #000; border-color: var(--accent-gold); }
    .sort-bar { background: #1a1a1a; padding: 8px 30px; display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; border-bottom: 1px solid #333; }
    .sort-btn { cursor: pointer; display: flex; align-items: center; gap: 5px; }

    /* リスト表示 */
    .content-scroll { flex: 1; overflow-y: auto; padding: 0 30px 40px 30px; }
    .item-entry { border-bottom: 1px solid #333; padding: 20px 0; display: flex; justify-content: space-between; align-items: flex-start; }
    .item-card { display: flex; gap: 15px; }
    .item-img { width: 150px; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #444; }
    .item-price { color: var(--accent-gold); font-size: 1.1rem; font-weight: bold; margin-left: 20px; white-space: nowrap; }

    /* 特集ページ（画像全幅） */
    .special-item { margin-bottom: 40px; }
    .special-img { width: 100%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.8); }

    /* モーダル */
    .info-icon { display: inline-block; width: 20px; height: 20px; line-height: 20px; text-align: center; border: 1px solid var(--accent-gold); color: var(--accent-gold); border-radius: 50%; font-size: 0.7rem; margin-left: 8px; cursor: pointer; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; }
    .modal-content { background: #252525; border-top: 4px solid var(--accent-gold); padding: 30px; width: 85%; max-width: 600px; border-radius: 12px; position: relative; }
    .modal-close { position: absolute; top: 10px; right: 20px; color: #888; font-size: 2rem; cursor: pointer; }
</style>
</head>
<body>

<nav class="sidebar">
    <a href="#recommend" class="tab-link" id="link-recommend">おすすめ</a>
    <a href="#whisky" class="tab-link" id="link-whisky">ウイスキー</a>
    <a href="#spirits" class="tab-link" id="link-spirits">SPIRITS</a>
    <a href="#beer" class="tab-link" id="link-beer">BEER</a>
    <a href="#wine" class="tab-link" id="link-wine">WINE</a>
    <a href="#food" class="tab-link" id="link-food">フード</a>
    <a href="#knowledge" class="tab-link" id="link-knowledge">図鑑・知識</a>
    <a href="#map" class="tab-link" id="link-map">MAP</a>
</nav>

<main class="main-area">
    <div class="header">
        <h2 class="page-title" id="page-title">MENU</h2>
        <div class="lang-btns">
            <button class="lang-btn active" onclick="setLang('jp')">JP</button>
            <button class="lang-btn" onclick="setLang('en')">EN</button>
            <button class="lang-btn" onclick="setLang('ko')">KO</button>
            <button class="lang-btn" onclick="setLang('zh')">ZH</button>
            <button class="lang-btn" onclick="setLang('es')">ES</button>
        </div>
    </div>

    <div class="filter-area" id="filter-area" style="display:none;">
        <div class="region-row" id="region-btns"></div>
        <div class="sub-region-row" id="sub-region-btns"></div>
    </div>

    <div class="sort-bar" id="sort-bar">
        <div class="sort-btn" onclick="toggleSort('name')">銘柄名 <span id="icon-name">▲</span></div>
        <div class="sort-btn" onclick="toggleSort('price')">価格 <span id="icon-price">⇅</span></div>
    </div>

    <div class="content-scroll" id="main-content"></div>
</main>

<div id="modal-overlay" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <h2 id="modal-title" style="color:var(--accent-gold); margin-top:0;"></h2>
        <div id="modal-body" style="white-space:pre-wrap; color:#ccc; line-height:1.8;"></div>
    </div>
</div>

<script src="menu_data.js" charset="UTF-16"></script>
<script>
    if (sessionStorage.getItem("isLoggedIn") !== "true") { window.location.href = "login.html"; }

    let state = { category: "recommend", lang: "jp", region: "ALL", subRegion: "ALL", sort: { key: 'name', direction: 1 } };
    const SUB_REGION_ORDER = ["ALL", "GIN", "VODKA", "RUM", "TEQUILA", "WHISKY", "BRANDY", "LIQUEUR", "BEER", "WINE", "COFFEE"];
    const labels = {
        jp: { recommend: "おすすめ", whisky: "ウイスキー", spirits: "SPIRITS", beer: "BEER", wine: "WINE", food: "フード", knowledge: "図鑑・知識", map: "MAP" },
        en: { recommend: "Recommend", whisky: "Whisky", spirits: "Spirits", beer: "Beer", wine: "Wine", food: "Food", knowledge: "Knowledge", map: "MAP" }
    };

    function setLang(l) {
        state.lang = l;
        document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase() === l));
        renderPage();
    }

    function toggleSort(key) {
        if (state.sort.key === key) state.sort.direction *= -1;
        else { state.sort.key = key; state.sort.direction = 1; }
        renderPage();
    }

    window.addEventListener('hashchange', () => { 
        state.category = window.location.hash.replace('#','') || 'recommend';
        state.region = "ALL"; state.subRegion = "ALL";
        renderFilters(); renderPage(); 
    });
    window.addEventListener('load', () => { 
        state.category = window.location.hash.replace('#','') || 'recommend'; 
        renderFilters(); renderPage(); 
    });

    function showModal(name, note) {
        document.getElementById('modal-title').innerText = name;
        document.getElementById('modal-body').innerText = note;
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    function renderFilters() {
        const filterArea = document.getElementById('filter-area');
        const regionRow = document.getElementById('region-btns');
        const subRow = document.getElementById('sub-region-btns');
        
        // 修正：定義を追加
        const categoryItems = menuData.filter(i => i.category === state.category);
        const regions = [...new Set(categoryItems.map(i => i.region).filter(Boolean))];
        const availableSubs = [...new Set((state.region === 'ALL' ? categoryItems : categoryItems.filter(i => i.region === state.region)).map(i => i.sub_region).filter(Boolean))];

        if (regions.length === 0 && availableSubs.length === 0) { filterArea.style.display = 'none'; return; }
        filterArea.style.display = 'flex'; regionRow.innerHTML = ''; subRow.innerHTML = '';

        if (regions.length > 0) {
            ['ALL', ...regions.sort()].forEach(r => {
                const btn = document.createElement('button'); btn.className = 'filter-btn' + (state.region === r ? ' active' : '');
                btn.innerText = r; btn.onclick = () => { state.region = r; state.subRegion = "ALL"; renderFilters(); renderPage(); };
                regionRow.appendChild(btn);
            });
        }
        if (availableSubs.length > 0) {
            const sortedSubs = availableSubs.sort((a, b) => {
                let indexA = SUB_REGION_ORDER.indexOf(a.toUpperCase()); let indexB = SUB_REGION_ORDER.indexOf(b.toUpperCase());
                return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
            });
            ['ALL', ...sortedSubs].forEach(s => {
                const btn = document.createElement('button'); btn.className = 'sub-btn' + (state.subRegion === s ? ' active' : '');
                btn.innerText = s; btn.onclick = () => { state.subRegion = s; renderFilters(); renderPage(); };
                subRow.appendChild(btn);
            });
        }
    }

    function renderPage() {
        const container = document.getElementById('main-content');
        
        // タブの文字を更新
        document.querySelectorAll('.tab-link').forEach(l => {
            const cat = l.id.replace('link-','');
            l.classList.toggle('active', cat === state.category);
            l.innerText = (labels[state.lang] && labels[state.lang][cat]) || (i18n[state.lang] && i18n[state.lang][cat]) || cat.toUpperCase();
        });
        document.getElementById('page-title').innerText = (labels[state.lang] && labels[state.lang][state.category]) || state.category.toUpperCase();
        
        let items = menuData.filter(i => i.category === state.category);

        // 特集ページ（図鑑・知識・マップ）の専用表示
        if (state.category === 'knowledge' || state.category === 'map') {
            document.getElementById('sort-bar').style.display = 'none';
            container.innerHTML = items.map(item => `
                <div class="special-item">
                    <h3 style="color:var(--accent-gold); font-size:1.4rem;">${item[`name_${state.lang}`] || item.name_jp}</h3>
                    <img src="${item.image}" class="special-img" onerror="this.src='images/no-image.png'">
                    <p style="color:#ccc; margin-top:15px; line-height:1.6;">${item[`desc_${state.lang}`] || item.desc_jp}</p>
                </div>
            `).join('');
            return;
        }

        document.getElementById('sort-bar').style.display = 'flex';
        if (state.region !== 'ALL') items = items.filter(i => i.region === state.region);
        if (state.subRegion !== 'ALL') items = items.filter(i => i.sub_region === state.subRegion);

        // ソート処理
        items.sort((a, b) => {
            let vA = a[state.sort.key === 'name' ? `name_${state.lang}` : 'price'] || a['name_jp'];
            let vB = b[state.sort.key === 'name' ? `name_${state.lang}` : 'price'] || b['name_jp'];
            return (typeof vA === 'string' ? vA.localeCompare(vB) : vA - vB) * state.sort.direction;
        });

        document.getElementById('icon-name').innerText = state.sort.key === 'name' ? (state.sort.direction===1?'▲':'▼') : '⇅';
        document.getElementById('icon-price').innerText = state.sort.key === 'price' ? (state.sort.direction===1?'▲':'▼') : '⇅';

        container.innerHTML = items.length ? '' : '<p style="text-align:center; padding-top:50px; color:#555;">NO ITEMS</p>';

        items.forEach(item => {
            const name = item[`name_${state.lang}`] || item.name_jp;
            const sub = (state.lang === 'jp') ? item.name_en : item.name_jp;
            const desc = item[`desc_${state.lang}`] || item.desc_jp || '';
            const info = item.note_jp ? `<span class="info-icon" onclick="showModal('${name}', \`${item.note_jp.replace(/\n/g, '<br>')}\`)">i</span>` : '';
            
            if (item.image) {
                container.innerHTML += `
                    <div class="item-entry">
                        <div class="item-card">
                            <img src="${item.image}" class="item-img" onerror="this.src='images/no-image.png'">
                            <div class="item-text">
                                <h3>${name}${info}</h3><div style="font-size:0.8rem; color:#888;">${sub}</div>
                                <div style="font-size:0.8rem; color:#aaa; margin-top:8px;">${desc}</div>
                            </div>
                        </div><div class="item-price">¥${item.price.toLocaleString()}</div>
                    </div>`;
            } else {
                container.innerHTML += `
                    <div class="item-entry">
                        <div class="item-text">
                            <h3>${name}${info}</h3><div style="font-size:0.8rem; color:#888;">${sub}</div>
                            <div style="font-size:0.8rem; color:#aaa; margin-top:8px;">${desc}</div>
                        </div><div class="item-price">¥${item.price.toLocaleString()}</div>
                    </div>`;
            }
        });
    }
</script>
</body>
</html>